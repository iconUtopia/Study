# æ— å¤„ä¸åœ¨çš„å‘å¸ƒè®¢é˜…æ¨¡å¼

[åŸæ–‡](https://juejin.cn/post/6913719524516691975)

## å‰è¨€

å®ƒå®šä¹‰äº†å¯¹è±¡é—´çš„ä¸€ç§ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œè®©å¤šä¸ªè§‚å¯Ÿè€…å¯¹è±¡åŒæ—¶ç›‘å¬æŸä¸€ä¸ªä¸»é¢˜å¯¹è±¡ï¼Œå½“ä¸€ä¸ªå¯¹è±¡å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡éƒ½å°†å¾—åˆ°é€šçŸ¥ã€‚

æ —å­ï¼š

é¥æ§ç‚¸å¼¹å°±æ˜¯ã€Œå‘å¸ƒè®¢é˜…ã€çš„ä¸€ç§ç”Ÿæ´»ä¸­çš„åº”ç”¨ï¼Œä½ æŠŠç‚¸å¼¹ ğŸ’£ åŸ‹åœ¨æŸè¾†è½¦åº•ï¼Œç„¶åååœ¨è½¦å¯¹é¢çš„æ˜Ÿå·´å…‹å–å’–å•¡ï¼Œä¸€æ—¦çŒç‰©ä¸Šè½¦ï¼Œä½ æŒ‰ä¸‹æŒ‰é’®ï¼Œç‚¸å¼¹çˆ†ç‚¸ã€‚è¿™ä¸€æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œç‚¸å¼¹ã€Œè®¢é˜…ã€äº†ä½ ï¼Œè€Œã€Œå‘å¸ƒã€çš„æƒåˆ©åœ¨ä½ æ‰‹ä¸Šçš„æŒ‰é’®ã€‚

## å‰ç«¯é¢†åŸŸçš„åº”ç”¨

### åŸç”Ÿ JS

```js
document.body.addEventListener("click", () => {
  console.log("ç›‘å¬ç‚¹å‡»äº‹ä»¶");
});
```

ä¸Šè¿°ä»£ç é€šè¿‡ `addEventListener` æ–¹æ³•è®¢é˜…äº† `body` çš„ç‚¹å‡»äº‹ä»¶ï¼Œç‚¹å‡»ä»»ä½• `body` å†…çš„æ ‡ç­¾ï¼Œéƒ½ä¼šè§¦å‘å›è°ƒå‡½æ•°çš„æ‰§è¡Œã€‚

### jQuery

```js
$(".demo").on("click", () => {
  // do something
```

### Vue

ã€Œå‘å¸ƒè®¢é˜…ã€æ¨¡å¼è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒç»å…¸çš„åº”ç”¨æ˜¯ `Vue 2.x` ä¸­çš„åŒå‘ç»‘å®šåŸç† `Object.defineProperty`

```js
const obj = { name: "Nick" };
Object.defineProperty(obj, "name", {
  set: function() {
    console.log("è§¦å‘æ›´æ–°");
  }
});
```

ä»£ç ä¸­è®¢é˜…äº† `name` å±æ€§ï¼Œä¸€æ—¦å®ƒå‘ç”Ÿå˜åŒ–ï¼Œ `set` å‡½æ•°ä¾¿ä¼šæ‰§è¡Œã€‚åŒæ ·æˆ‘ä»¬ä¸ç”¨å»å…³å¿ƒ `name` å±æ€§åœ¨ä»€ä¹ˆæ—¶å€™ä¼šå‘ç”Ÿå˜åŒ–ï¼Œåªè¦å®ƒæ•¢å˜ï¼Œ `set` å°±ä¼šè¢«è§¦å‘ã€‚

```html
<Child @submit="sendPost"></Child>
```

è¿™æ˜¯ç»„ä»¶é—´çš„æ–¹æ³•ä¼ å€¼ï¼Œä¸€ç‚¹å­ç»„ä»¶å†…é€šè¿‡ `emit` æ–¹æ³•å‘å¸ƒ `submit`ï¼Œçˆ¶ç»„ä»¶çš„ `sendPost` æ–¹æ³•å°±ä¼šè¢«è§¦å‘ã€‚

## æ‰‹å†™ä¸€ä¸ªå»ºè®®çš„ EventBus

EventBus ç±»ä¸­æŠ›å‡º 3 ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯ï¼š

- onï¼šè®¢é˜…æ–¹æ³•ï¼Œåœ¨æŸä¸ªç»„ä»¶æˆ–è€…é¡µé¢å¼•å…¥ on æ–¹æ³•ï¼Œå®šä¹‰è§¦å‘çš„å‡½æ•°æ–¹æ³•ã€‚
- emitï¼šè§¦å‘æ–¹æ³•ï¼Œæ ¹æ®ä¸Šé¢çš„è®¢é˜…æ–¹æ³•ï¼Œè§¦å‘å®ƒã€‚
- offï¼šé”€æ¯è®¢é˜…çš„ç±»å‹ï¼Œç±»ä¼¼ `document.removeEventListener` ã€‚

```js
class EventBus {
  constructor() {
    this.handleMaps = {}; // åˆå§‹åŒ–ä¸€ä¸ªå­˜æ”¾è®¢é˜…å›è°ƒæ–¹æ³•çš„æ‰§è¡Œæ ˆ
  }

  /**
   * è®¢é˜…æ–¹æ³•ï¼Œæ¥æ”¶ä¸¤ä¸ªå‚æ•°
   * type: ç±»å‹åç§°
   * handlerï¼šè®¢é˜…å¾…æ‰§è¡Œçš„æ–¹æ³•
   */
  on(type, handler) {
    if (!(handler instanceof Function)) {
      throw new Error("åˆ«é—¹äº†ï¼Œç»™å‡½æ•°ç±»å‹"); // handler å¿…é¡»æ˜¯å¯æ‰§è¡Œçš„å‡½æ•°
    }
    // å¦‚æœç±»å‹åä¸å­˜åœ¨ï¼Œåˆ™æ–°å»ºå¯¹åº”ç±»å‹åçš„æ•°ç»„
    if (!(type in this.handleMaps)) {
      this.handleMaps[type] = [];
    }
    // å°†å¾…æ‰§è¡Œæ–¹æ³•å¡å…¥å¯¹åº”ç±»å‹åæ•°ç»„
    this.handleMaps[type].push(handler);
  }

  /**
   * å‘å¸ƒæ–¹æ³•ï¼Œæ¥æ”¶ä¸¤ä¸ªå‚æ•°
   * type: ç±»å‹åç§°
   * paramsï¼šä¼ å…¥å¾…æ‰§è¡Œæ–¹æ³•çš„å‚æ•°
   */
  emit(type, params) {
    if (type in this.handleMaps) {
      this.handleMaps[type].forEach(handler => {
        // æ‰§è¡Œè®¢é˜…æ—¶ï¼Œå¡å…¥çš„å¾…æ‰§è¡Œæ–¹æ³•ï¼Œå¹¶ä¸”å¸¦å…¥ params å‚æ•°
        handler(params);
      });
    }
  }

  // é”€æ¯æ–¹æ³•
  off(type) {
    if (type in this.handleMaps) {
      delete this.handleMap[type];
    }
  }
}

export default new EventBus();
```

## åº”ç”¨äºå®è·µ

æ–°å»ºä¸€ä¸ª Vue åŸºç¡€é¡¹ç›®ï¼Œæ–°å»º utils/event_bus.jsï¼Œå­˜æ”¾ä¸Šè¿°ç¼–å†™çš„ä»£ç ã€‚

### éªŒè¯ä¸€ï¼šçˆ¶å­é€šä¿¡ç»„ä»¶

ä¿®æ”¹ `Home.vue` å¦‚ä¸‹æ‰€è¯´ï¼š

```html
<template>
  <div class="home">
    æŠ€èƒ½ï¼š{{ skill }}
    <Child />
  </div>
</template>

<script>
  import Child from "@/components/Child";
  import eventBus from "@/utils/event_bus";
  import { onMounted, ref } from "vue";
  export default {
    name: "Home",
    components: {
      Child
    },
    setup() {
      const skill = ref("");
      onMounted(() => {
        // è®¢é˜… skill ç±»å‹å
        eventBus.on("skill", key => {
          skill.value = key;
          console.log("key", key);
        });
      });

      return {
        skill
      };
    }
  };
</script>
```
